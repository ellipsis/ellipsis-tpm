#!/usr/bin/env bash
##############################################################################
# @file ellipsis-tpm
# @date January, 2016
# @author G. Roggemans <g.roggemans@grog.be>
# @copyright Copyright (c) GROG [https://grog.be] 2016, All Rights Reserved
# @license MIT
##############################################################################

# Tmux must run!
if [[ -z $TMUX ]] && [[ -z $TPM_NOTMUX ]]; then
    echo "Tmux not running!"
    exit 1
fi

##############################################################################

TPM_BIN="${BASH_SOURCE[0]}"

# Unlink script location
loopcount=0
while [ $loopcount -lt 1000 ]
do
    # Avoid infinit loops
    let loopcount=loopcount+1

    # If still a link, unlink, else break the loop
    if [ -L "$TPM_BIN" ]; then
        TPM_BIN="$(readlink "$TPM_BIN")"
    else
        break
    fi
done

# Set PATH vars
ELLIPSIS_PATH="${ELLIPSIS_PATH:-$(cd "$(dirname "$TPM_BIN")/../../.." && pwd)}"
ELLIPSIS_SRC="$ELLIPSIS_PATH/src"
TPM_PATH="$(cd "$(dirname "$TPM_BIN")/.." && pwd)"
TPM_SRC="$TPM_PATH/src"

##############################################################################

# Provides load function and global vars
source "$TPM_SRC/init.bash"

load cli "$TPM_SRC"

# check for controlling terminal
if [ -t 1 ]; then
    cli.run $@
    exit $?
else
    # strip ansi colors
    cli.run $@ | sed -e 's/\[[^m]*m//g'
    exit $PIPESTATUS # exit with result of first command in pipe, i.e., cli.run
fi

##############################################################################
